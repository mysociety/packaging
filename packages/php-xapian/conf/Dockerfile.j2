FROM base-builder:{{ codename }}-latest
LABEL maintainer="{{ vendor }} <{{ vendor_email }}>"

ARG SOURCE_URL={{ source_url }}

RUN apt-get -qq update \
      && apt-get install -qq \
         libxapian30 \
         libxapian-dev \
         php{{ versions[codename].php }}-cli \
         php{{ versions[codename].php }}-dev \
         xapian-tools \
      && rm -fr /var/lib/apt/lists/*

WORKDIR /home/builder
USER builder

# Get the sources
RUN wget -q ${SOURCE_URL}/xapian-bindings_{{ versions[codename].xapian }}.orig.tar.xz \
      && tar xJf xapian-bindings_{{ versions[codename].xapian }}.orig.tar.xz

# Setup
WORKDIR xapian-bindings-{{ versions[codename].xapian }}
RUN ./configure --with-php XAPIAN_CONFIG=/usr/bin/xapian-config PHP_CONFIG=/usr/bin/php-config \
    && make \
    && chmod 0644 php/.libs/xapian.so \
    && fpm -s dir -t deb \
      --vendor "mySociety" \
      --maintainer "mySociety <sysadmin@mysociety.org>" \
      --version "{{ versions[codename].xapian }}" \
      --iteration "{{ iteration }}" \
      --architecture "amd64" \
      --url "https://xapian.org/" \
      --description "Xapian bindings for PHP {{ versions[codename].php }}" \
      --depends "phpapi-{{ versions[codename].phpapi }}" \
      --depends "php{{ versions[codename].php }}-common" \
      --depends "libxapian30 (>={{ versions[codename].xapian }}~)" \
      -n "php-xapian" \
      ./php/docs/index.html=/usr/share/doc/php-xapian/index.html \
      ./php/docs/examples/=/usr/share/doc/php-xapian/examples/ \
      ./php/.libs/xapian.so=/usr/lib/php/{{ versions[codename].phpapi }}/xapian.so

WORKDIR /home/builder
CMD ["sh", "-c", "/bin/mv xapian-bindings-{{ versions[codename].xapian }}/*.deb ./deb/{{ codename }}"]
