FROM base-builder:{{ codename }}-latest
LABEL maintainer="{{ vendor }} <{{ vendor_email }}>"

{% if codename == 'bullseye' -%}
RUN mkdir -p /etc/apt/keyrings/ && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key > /etc/apt/keyrings/nodesource.asc
{% else -%}
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key > /etc/apt/keyrings/nodesource.asc
{% endif -%}

{% set node_version = '22' -%}

RUN echo 'deb [signed-by=/etc/apt/keyrings/nodesource.asc] https://deb.nodesource.com/node_{{ node_version }}.x nodistro main' > /etc/apt/sources.list.d/nodesource.list

RUN apt-get update -qq && apt-get install -qq nodejs >/dev/null

WORKDIR /home/builder
USER builder
RUN fpm -s npm -t deb \
      --vendor "{{ vendor }}" \
      --maintainer "{{ vendor }} <{{ vendor_email }}>" \
      --license "MIT" \
{% for dependency in dependencies %}
      --depends "{{ dependency }}" \
{% endfor %}
      --iteration "{{ iteration }}" \
      jshint@{{ version }}

CMD ["sh", "-c", "/bin/mv *.deb ./deb/{{ codename }}"]
