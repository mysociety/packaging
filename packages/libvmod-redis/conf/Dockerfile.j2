FROM base-builder:{{ codename }}-latest
LABEL maintainer="{{ vendor }} <{{ vendor_email }}>"

ENV VARNISHAPI_VMODDIR=/usr/lib/x86_64-linux-gnu/varnish/vmods/

RUN apt-get update -qq \
      && apt-get install -y -qq \
         autotools-dev \
         automake \
         graphviz \
         libedit-dev \
         libev-dev \
         libhiredis-dev \
         libjemalloc-dev \
         libncurses-dev \
         libpcre2-dev \
         libssl-dev \
         libtool \
         libvarnishapi-dev \
         pkg-config \
         python3-docutils \
         python3-sphinx \
         redis-server \
         varnish \
       && rm -fr /var/lib/apt/lists/*

USER builder

WORKDIR /home/builder
{% if codename == "bookworm" or codename == "bullseye" %}
RUN git clone https://github.com/mysociety/libvmod-redis.git
{% else %}
RUN git clone https://github.com/carlosabalde/libvmod-redis.git
{% endif %}

WORKDIR /home/builder/libvmod-redis

{% if codename == "bookworm" or codename == "bullseye" %}
RUN git checkout origin/{{ codename }} \
{% else %}
RUN git checkout origin/{{ varnish_version[codename] }}-archived \
{% endif %}
      && ./autogen.sh \
      && debuild -e VARNISHAPI_VMODDIR --no-tgz-check -us -uc 

WORKDIR /home/builder  
CMD ["sh", "-c", "/bin/mv *.deb ./deb/{{ codename }}"]
